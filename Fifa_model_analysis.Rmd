---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
library(readr)
FullData <- read_csv("/home/oem/Code/mlprojects/FIFA/more/complete.csv", show_col_types = FALSE)
complemento <- read_csv("/home/oem/Code/mlprojects/FIFA/demo/CompleteDataset.csv", show_col_types = FALSE)
```
```{r}
library(data.table)
setDT(FullData)
setDT(complemento)
names(FullData)
```
```{r}
dim(FullData)
```
```{r}
library(knitr)
kable(head(FullData))
```
```{r}
library(ggplot2)
ggplot(FullData, aes(age, fill = age)) +
geom_density(position = "stack") 
```
```{r}
library(dplyr)
FullData %>% 
  ggplot(aes(x = overall, fill = factor(overall))) +
  geom_bar(color = "grey20") + guides(fill = FALSE)+
  labs(title="Player's Overall ")
```
```{r}
agerating <- FullData[age<41,.("overall"=mean(overall)),by=age][order(-age)]
ggplot(data = agerating,aes(x=age,y=overall))+
  geom_line(color="red",size=2)+labs(title="Rating vs Age")+
  annotate("text", x = 30, y = max(agerating$overall),color="blue", label = "Max", parse = TRUE, size = 3)
```
```{r}
library(data.table)
FullData %>% 
  #arrange(-overall) %>% 
  #top_n(15,wt = overall) %>% 
  select(name, age,overall,club,eur_value) %>% 
  as.data.table(class = "nowrap hover row-border", escape = FALSE, options = list(dom = 't',scrollX = TRUE, autoWidth = TRUE))
```
```{r}
FullData %>% 
  ggplot(aes(x = height_cm, fill = factor(height_cm))) +
  geom_bar(color = "grey20") + guides(fill = FALSE)+
  labs(title="Players Height")


```
```{r}
FullData %>% 
  ggplot(aes(x = weight_kg, y = overall, fill = factor(height_cm))) +
  geom_point(color = "grey20") + guides(fill = FALSE)+
  labs(title="Players Weight")
```
```{r}
Nationalitys <- FullData[FullData$nationality!="",.N,by=.(nationality,`flag`)][order(-N)]

Nationalitys = Nationalitys[,c(1,3)] 
head(Nationalitys[order(Nationalitys$N, decreasing = TRUE),],10)
```
```{r}
TeamDF<-arrange(FullData[, list(Avg=mean(overall)), by= "club" ], desc(Avg) )

kable(head(TeamDF, 10))

```
```{r}
cluster = FullData[,c(7,10,11,17:29,34:94)]
cluster[is.na(cluster)] = 0
wss <- (nrow(cluster[,c()])-1)*sum(apply(cluster[,1:ncol(cluster)],2,var))

for (i in 2:10) 
  wss[i] <- sum(kmeans(cluster[,1:ncol(cluster)], centers=i)$withinss)

plot(1:
       10, wss, type="b", xlab="Number of Cluster",  ylab="Squares Summatory")
```
```{r}
library(fpc)
set.seed(123)
km<-kmeans(cluster[,1:ncol(cluster)],4)
cluster$grupo<-km$cluster
FullData$grupo <-km$cluster
g1<- FullData[FullData$grupo==1,]
g2<- FullData[FullData$grupo==2,]
g3<- FullData[FullData$grupo==3,]
g4<- FullData[FullData$grupo==4,]

plotcluster(cluster[,1:(ncol(cluster)-1)],km$cluster)
```
```{r}

g1 %>% 
  ggplot(aes(x = overall, fill = factor(overall))) +
  geom_histogram(binwidth=1)+
  labs(title="Raiting de los Jugadores")

ggplot(FullData %>% count(club), aes(x = club, n, group="eur_value")) + 
  geom_line() +
  labs(title = "Player Ratings")


```
```{r}
ggplot(g1, aes(eur_value, fill = eur_value)) +
geom_density(position = "stack")
```
```{r}
summary(g1$eur_value)
```
```{r}
library(caret)
library(plyr)
specs = FullData[,c(22:30,36:67)]
specs = data.frame(specs)

## Specs normalization
specsNorm = preProcess(specs,method = "scale")
specs = predict(specsNorm, specs)
## Adding ID and Overall to Specs
id_overall = FullData[,c(1,20)]
specs = cbind(specs,id_overall)

##Getting prefered_positions and ID
positions = complemento[,c(53,64)]   
positions = data.frame(positions)

## Cleaning Preferred Positions

prefered_positions = positions[,'Preferred.Positions']
split = strsplit(prefered_positions, split=" ")
positionVector = 0
length = length(split)
for (position in 1:length) {
    positionVector[position] <- unlist(split[[position]][1]) 
  }
positions[,'Preferred.Positions'] = positionVector

#Joining data
selected_data = join(specs, positions, by = NULL, type = "full", match = "first") 
selected_data = selected_data[complete.cases(selected_data),]

#Attack or Defense
position = selected_data[,'Preferred.Positions']
attack = c('ST','LW','RW','RM','CM','LM','CAM','CF')
defense = c('CDM','CB','LB','RB','RWB','LWB','GK')
#Replacing
position <- lapply(position, function(x) replace(x,x %in% attack, 1))
position <- lapply(position, function(x) replace(x,x %in% defense, 0))

positionVector = 0
for (i in 1:length(position)){
    positionVector[i] = position[[i]]
}

positionVector = as.numeric(positionVector)

#joining 
selected_data = cbind(selected_data,positionVector)

selected_data <- subset( selected_data, select = -ID )
selected_data[,'Preferred.Positions'] = as.factor(selected_data[,'Preferred.Positions'])

kable(head(selected_data))
```
```{r}
porciento <- 70/100

set.seed(3)

trainRowsNumber<-sample(1:nrow(selected_data),porciento*nrow(selected_data))
train<-selected_data[trainRowsNumber,] 
test<-selected_data[-trainRowsNumber,] 

ataque = selected_data[selected_data[,'positionVector'] ==1,-positionVector]
ataque$Preferred.Positions = factor(ataque$Preferred.Positions)
defensa = selected_data[selected_data[,'positionVector'] ==0,-positionVector]
defensa$Preferred.Positions = factor(defensa$Preferred.Positions)

trainRowsNumber<-sample(1:nrow(ataque),porciento*nrow(ataque))
trainA<-ataque[trainRowsNumber,] 
testA<-ataque[-trainRowsNumber,] 

trainRowsNumber<-sample(1:nrow(defensa),porciento*nrow(defensa))
trainD<-defensa[trainRowsNumber,] 
testD<-defensa[-trainRowsNumber,] 

kable(head(train)) 
```
```{r}
modelo<-glm(positionVector~., data = train)
pred<-predict(modelo,newdata = test)
pred = round(pred)
cfmLR = confusionMatrix(table(pred,test$positionVector))
cfmLR
```
```{r}
library(e1071)
model <- svm(Preferred.Positions~. ,data=trainA,kernel = "linear")
prediccion <- predict(model,testA)
#prediccion = round(prediccion, digits = 0)
cfmSVM<-confusionMatrix(table(prediccion,testA[,'Preferred.Positions']))
cfmSVM
```
```{r}
modelD <- svm(Preferred.Positions~. ,data=trainD,kernel = "linear")
prediccion <- predict(modelD,testD)
cfmSVM<-confusionMatrix(table(prediccion,testD[,'Preferred.Positions']))
cfmSVM
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
